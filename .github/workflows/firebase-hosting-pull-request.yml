# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR
"on": pull_request
jobs:
    build_and_preview:
        if: "${{ github.event.pull_request.head.repo.full_name == github.repository }}"
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            # Git Secret
            - name: Install Git secret
              run: |
                  sudo sh -c "echo 'deb https://gitsecret.jfrog.io/artifactory/git-secret-deb git-secret main' >> /etc/apt/sources.list"
                  wget -qO - 'https://gitsecret.jfrog.io/artifactory/api/gpg/key/public' | sudo apt-key add -
                  sudo apt-get update && sudo apt-get install -y git-secret
            - name: Git secret import key
              env:
                  GPG_SECRET: "${{ secrets.GPG_SECRET }}"
              run: |
                  gpg --batch --import <(echo "$GPG_SECRET")
            - name: Git secret reveal
              env:
                  GIT_SECRET: "${{ secrets.GIT_SECRET }}"
              run: |
                  git secret reveal -p $GIT_SECRET

            # Node Cache
            - name: Cache node modules
              uses: actions/cache@v2
              env:
                  cache-name: cache-node-modules
              with:
                  # npm cache files are stored in `~/.npm` on Linux/macOS
                  path: ~/.npm
                  key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-build-${{ env.cache-name }}-
                      ${{ runner.os }}-build-
                      ${{ runner.os }}-
            - name: Set up Node
              run: |
                  npm install -g react-scripts
                  npm install -g yarn
            - name: Install Yarn Dependencies
              run: yarn install
            - run: yarn run test --watchAll=false && yarn run build
            - uses: FirebaseExtended/action-hosting-deploy@v0
              with:
                  repoToken: "${{ secrets.GITHUB_TOKEN }}"
                  firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_PORTFOLIO_F1543 }}"
                  projectId: portfolio-f1543
